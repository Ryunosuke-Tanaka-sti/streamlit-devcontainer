# X 予約投稿管理アプリ プロジェクト企画書

## プロジェクト概要

### プロジェクト名

**X Scheduler Pro - Markdown 投稿管理システム**

### 目的

X API 無料プランの制約下で、Markdown ファイルベースの予約投稿管理に特化した Streamlit アプリケーションを開発する。

### 対象環境

- ローカル開発環境
- Microsoft Azure クラウド環境（オプション）

### 開発期間

**4-5 週間**（3 つのタスクに分割）

---

## 背景・課題

### X API 無料プラン制約

- **投稿制限**: 500 投稿/月
- **レート制限**: 17 投稿/24 時間
- **機能制限**: 分析機能、検索機能が利用不可
- **利用可能**: 投稿機能のみ

### 解決すべき課題

- Markdown ファイルベースでの投稿管理
- 厳しいレート制限下での効率的な投稿
- 簡単で直感的な操作インターフェース
- 投稿履歴・統計の適切な管理

---

## ソリューション概要

### コア機能

1. **OAuth 2.0 認証**: X アカウントでの安全なログイン
2. **Markdown ファイル管理**: ローカルファイルでの投稿コンテンツ管理
3. **2 ペイン投稿 UI**: 直感的な投稿作成インターフェース
4. **レート制限管理**: 制約下での効率的な投稿管理
5. **投稿履歴**: Firestore による投稿データ管理

### 技術的特徴

- **無料サービス活用**: X API、Firestore 無料枠の最大活用
- **ハイブリッド設計**: ローカルファイル + クラウドデータベース
- **シンプル実装**: 必要最小限の機能に特化

---

## 機能要件

### 1. 認証機能

- **X OAuth 2.0 認証**
  - Authorization Code Flow with PKCE
  - セッション管理
  - アクセストークンの自動更新

### 2. Markdown ファイル管理

- **ローカル管理**
  - `./markdown/` ディレクトリでの管理
  - ファイル作成・編集・削除
  - リアルタイムプレビュー

### 3. 投稿機能

- **2 ペイン構成 UI**
  - 左: Markdown ファイル一覧・プレビュー
  - 右: 投稿設定・スケジュール
- **投稿実行**
  - 即時投稿
  - 予約投稿（基本実装）

### 4. 制限管理

- **レート制限監視**
  - 17 投稿/24 時間の管理
  - 500 投稿/月の管理
  - 制限状況の可視化

### 5. データ管理

- **投稿履歴**: Firestore での管理
- **統計情報**: 投稿数・成功率の追跡
- **エラー管理**: 失敗原因の記録・分析

---

## システム構成

### アーキテクチャ

```
[Streamlit UI]
    ↓
[OAuth 2.0認証]
    ↓
[MarkdownファイルManager] ←→ [ローカルファイル]
    ↓
[投稿処理Engine]
    ↓
[X API v2] + [Firestore]
```

### 技術スタック

- **フロントエンド**: Streamlit
- **認証**: X OAuth 2.0 (PKCE)
- **API 通信**: requests
- **データベース**: Google Firestore
- **ファイル処理**: Python 標準ライブラリ
- **Markdown 処理**: python-markdown
- **スケジューリング**: APScheduler

---

## X API 仕様詳細

### 利用可能エンドポイント

```
POST /2/tweets
- 用途: ツイート投稿
- 制限: 17リクエスト/24時間
- パラメータ: text (最大280文字)

GET /2/users/me
- 用途: ユーザー情報取得
- 制限: 詳細不明
- 用途: 認証確認
```

### OAuth 2.0 認証フロー

1. **Authorization URL 生成** (PKCE 対応)
2. **ユーザー認証** (X 認証画面)
3. **認証コード取得** (コールバック)
4. **アクセストークン取得** (トークン交換)
5. **トークン管理** (更新・保存)

### 必要なスコープ

- `tweet.write`: ツイート投稿権限
- `users.read`: ユーザー情報読み取り権限

---

## データ設計

### Firestore 構成（投稿管理のみ）

```javascript
// posts コレクション
{
  "postId": "auto_generated_id",
  "title": "投稿タイトル",
  "content": "markdown_content",
  "markdownFilePath": "local_file_path",
  "scheduledTime": "timestamp",
  "status": "scheduled|posted|failed|cancelled",
  "xPostId": "x_platform_post_id",
  "postedAt": "timestamp",
  "viewCount": 0,
  "engagementStats": {
    "impressions": 0,
    "likes": 0,
    "retweets": 0,
    "updatedAt": "timestamp"
  },
  "createdAt": "timestamp",
  "updatedAt": "timestamp"
}
```

### ローカルデータ管理

- **認証情報**: Streamlit セッションステート
- **レート制限**: ローカル JSON ファイル
- **Markdown ファイル**: `./markdown/` ディレクトリ
- **設定情報**: `config.json`

---

## UI/UX 設計

### メインダッシュボード

```
X Scheduler Pro
===============

✅ ログイン中: @username

📊 投稿統計
- 今日: 3/17投稿 (残り14)
- 今月: 45/500投稿 (残り455)
- 予約中: 5件

📈 制限状況
Daily:  ████████░░ (8/17)
Monthly: ███░░░░░░░ (150/500)

🕐 次回リセット: 2024-01-02 00:00

📋 最近の投稿
- [12:34] "今日の振り返り" ✅
- [11:20] "イベント告知" ✅
- [09:15] "技術Tips" ✅
```

### 投稿作成画面（2 ペイン）

```
┌─────────────────┬───────────────────────────┐
│ 📁 Markdownファイル │ 📝 投稿作成                │
│                 │                         │
│ ┌─────────────┐ │ 投稿タイトル: ____________ │
│ │sample1.md   │ │                         │
│ │sample2.md   │ │ 選択ファイル: sample1.md   │
│ │template.md  │ │                         │
│ └─────────────┘ │ 🕐 スケジュール設定        │
│                 │ ○ 即時投稿 ○ 予約投稿     │
│ ┌─────────────┐ │ 日付: [2024-01-01]      │
│ │プレビュー    │ │ 時刻: [12:00]           │
│ │# Sample     │ │                         │
│ │今日の投稿... │ │ 📊 制限状況             │
│ │             │ │ 日次: ████░░░░░░ 8/17   │
│ │文字数: 45/280│ │ 月次: ███░░░░░░░ 150/500│
│ └─────────────┘ │                         │
│                 │ [📤 投稿実行]            │
│ [新規][編集][削除] │                         │
└─────────────────┴───────────────────────────┘
```

---

## 開発タスク分割

### Task 1: OAuth 2.0 認証実装

**期間**: 1-2 週間

- X Developer Portal 設定
- PKCE 対応 OAuth 実装
- Streamlit 認証フロー
- セッション管理

### Task 2: 2 ペイン UI + ファイル管理

**期間**: 1-2 週間

- 左右分割レイアウト
- Markdown ファイル管理機能
- リアルタイムプレビュー
- 投稿フォーム（モック接続）

### Task 3: X 投稿機能実装

**期間**: 1 週間

- X API v2 投稿機能
- Firestore 連携
- レート制限管理
- エラーハンドリング

---

## 技術的課題と対策

### 課題 1: OAuth 2.0 認証の複雑性

- **対策**: 標準ライブラリの活用
- **対策**: PKCE 実装の慎重な検証
- **対策**: セッション管理の簡素化

### 課題 2: レート制限管理

- **対策**: 事前チェック機能
- **対策**: 制限カウンターの正確な実装
- **対策**: 適切な待機・リトライ機能

### 課題 3: Streamlit 状態管理

- **対策**: `st.session_state`の効果的活用
- **対策**: ローカルファイルとの同期
- **対策**: 状態の永続化

### 課題 4: 無料枠制約

- **対策**: Firestore クエリの最適化
- **対策**: データ量の最小化
- **対策**: 効率的なキャッシュ戦略

### 課題 5: セキュリティ強化

- **対策**: Streamlit Secrets機能の活用
- **対策**: セッションタイムアウトの実装
- **対策**: CORS設定によるドメイン制限

### 課題 6: 開発環境のHTTPS要件

- **対策**: Windows側のngrokを活用したHTTPS化
- **対策**: OAuth callback URLの動的設定
- **対策**: 本番環境での適切なドメイン設定

---

## 成功指標

### 機能指標

- **投稿成功率**: 95%以上
- **レート制限遵守**: 100%
- **レスポンス時間**: 3 秒以内

### ユーザビリティ指標

- **投稿作成時間**: 3 分以内
- **エラー発生率**: 5%以下
- **学習コスト**: 初回使用で基本操作習得

### 技術指標

- **無料枠使用率**: Firestore 80%以下
- **認証成功率**: 99%以上
- **データ同期精度**: 100%
- **テストカバレッジ**: 80%以上
- **パフォーマンス**: 画面遷移3秒以内

---

## リスクと軽減策

### 技術リスク

| リスク             | 影響度 | 対策                         |
| ------------------ | ------ | ---------------------------- |
| X API 仕様変更     | 高     | 定期的な仕様確認・柔軟な実装 |
| Firestore 制限到達 | 中     | 使用量監視・最適化           |
| 認証エラー         | 中     | 適切なエラーハンドリング     |

### 運用リスク

| リスク         | 影響度 | 対策                   |
| -------------- | ------ | ---------------------- |
| レート制限超過 | 中     | 事前チェック・制限管理 |
| データ消失     | 低     | ローカルファイル併用   |
| 不正アクセス   | 低     | OAuth 2.0 + PKCE       |

---

## 成果物

### プログラムファイル

```
project/
├── src/
│   ├── main.py                 # Streamlitメインアプリ
│   ├── auth/
│   │   ├── __init__.py
│   │   ├── oauth_client.py     # OAuth2.0認証
│   │   └── pkce_utils.py       # PKCE実装
│   ├── api/
│   │   ├── __init__.py
│   │   ├── x_client.py         # X API v2クライアント
│   │   └── rate_limiter.py     # レート制限管理
│   ├── ui/
│   │   ├── __init__.py
│   │   ├── file_manager.py     # Markdownファイル管理
│   │   ├── post_form.py        # 投稿フォーム
│   │   └── preview.py          # プレビュー機能
│   ├── db/
│   │   ├── __init__.py
│   │   └── firestore_client.py # Firestore連携
│   └── utils/
│       ├── __init__.py
│       ├── markdown_utils.py   # Markdown処理
│       └── config.py           # 設定管理
├── markdown/                    # Markdownファイル保存
├── tests/                       # テストコード
├── .env.example                # 環境変数テンプレート
├── .streamlit/
│   └── secrets.toml            # Streamlit Secrets設定
├── requirements.txt            # 依存パッケージ
└── README.md                   # セットアップガイド
```

### ドキュメント

- **セットアップガイド**: 環境構築・設定手順
- **ユーザーマニュアル**: 操作方法・機能説明
- **API 仕様書**: X API 連携・Firestore 操作
- **トラブルシューティング**: よくある問題と解決方法

---

## 運用・保守

### 監視項目

- **投稿成功率**: 日次・週次での監視
- **レート制限使用量**: リアルタイム監視
- **エラー発生率**: 種類別の分析
- **Firestore 使用量**: 無料枠の監視

### 保守作業

- **X API 仕様確認**: 月次での確認
- **ログローテーション**: 週次でのクリーンアップ
- **バックアップ**: Markdown ファイルの定期バックアップ
- **セキュリティ更新**: 依存ライブラリの更新

---

## プロジェクト価値

### 個人ユーザー向け価値

- **効率化**: Markdown ベースでの快適な投稿管理
- **制約対応**: 無料 API 制限下での最適な運用
- **シンプル**: 学習コスト不要の直感的操作

### 技術的価値

- **無料枠活用**: コスト効率の高いシステム設計
- **モジュラー設計**: 機能追加・変更が容易
- **ベストプラクティス**: OAuth 2.0 + PKCE の実装例

### 発展可能性

- **機能拡張**: 画像投稿・分析機能の追加（有料プラン対応）
- **他 SNS 対応**: Mastodon、Bluesky 等への展開
- **企業利用**: チーム向け機能の追加
- **API統合**: Webhook対応・外部システム連携
- **分析機能**: 投稿パフォーマンス追跡・最適化提案

## パフォーマンス最適化戦略

### Streamlit最適化

- **キャッシュ活用**: `@st.cache_data`でAPIレスポンス・ファイル読み込みの高速化
- **セッション最適化**: 不要な再計算の防止
- **リアルタイム更新**: WebSocketによる効率的な状態同期

### Firestore最適化

- **バッチ処理**: 複数ドキュメントの一括操作
- **ページネーション**: 大量データの段階的読み込み
- **インデックス最適化**: クエリパフォーマンスの向上

### 非同期処理

- **予約投稿**: バックグラウンドでの投稿処理
- **ファイル処理**: 大容量Markdownファイルの非同期読み込み
- **API通信**: 非ブロッキング通信の実装

## エラー復旧・フォールバック機能

### 認証エラー対応

- **自動リフレッシュ**: トークン期限切れ時の自動更新
- **セッション復元**: ブラウザ再起動時の状態復元
- **フォールバック認証**: 複数認証方式の対応

### API障害対応

- **オフラインキュー**: ネットワーク障害時のローカル保存
- **リトライ機構**: 指数バックオフによる再試行
- **障害通知**: ユーザーへの適切な状況説明

### データ保護

- **ローカルバックアップ**: Markdownファイルの自動バックアップ
- **Firestoreフォールバック**: ローカルJSONファイルによる代替保存
- **データ同期**: 復旧時の整合性確保

---

## まとめ

本プロジェクトは、X API 無料プランの制約を逆手に取り、本当に必要な機能に特化したシンプルで実用的な投稿管理システムの構築を目指します。

3 つのタスクに分割された段階的開発により、確実で効率的な実装を実現し、個人ユーザーから小規模チームまで幅広く活用できるソリューションを提供します。

**コアバリュー**: 「制約の中での最適解」を追求し、無料サービスを最大活用したコスト効率の高いシステム実現
