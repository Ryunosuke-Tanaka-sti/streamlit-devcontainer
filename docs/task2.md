# Task 2: 2 分割 UI + Markdown ファイル表示

## 概要

左右 2 ペイン構成の Streamlit UI を構築し、左側でローカル Markdown ファイルの管理、右側で投稿作成フォームを実装する。X API 投稿機能はモック接続とする。

**開発期間**: 1-2 週間

---

## 実装内容

### 2 ペイン構成 UI

- **左ペイン**: Markdown ファイル管理・プレビュー
- **右ペイン**: 投稿作成フォーム
- **レスポンシブ対応**: 画面サイズに応じた調整
- **状態連携**: 左右ペイン間のデータ連動

### 左ペイン：Markdown ファイル管理

- **ファイル一覧**: `./markdown/`ディレクトリのファイル表示
- **ファイル選択**: クリックによる選択・プレビュー
- **ファイル操作**: 新規作成・編集・削除
- **プレビュー**: Markdown → HTML 変換表示

### 右ペイン：投稿作成フォーム

- **投稿設定**: タイトル・内容設定
- **スケジュール**: 日時指定機能
- **制限表示**: レート制限状況（ダミーデータ）
- **投稿ボタン**: モック処理での動作確認

---

## 技術要件

### 必要なライブラリ

```python
import streamlit as st
import markdown
import os
import glob
from datetime import datetime, timedelta
import json
```

### ディレクトリ構成

```
project/
├── app.py
├── markdown/
│   ├── sample1.md
│   ├── sample2.md
│   └── template.md
├── components/
│   ├── file_manager.py
│   ├── post_form.py
│   └── preview.py
└── utils/
    ├── file_utils.py
    └── markdown_utils.py
```

### Streamlit レイアウト

- `st.columns()`による 2 分割
- `st.sidebar`によるナビゲーション
- `st.container()`による区画整理

---

## 詳細機能仕様

### 左ペイン機能

#### ファイル一覧表示

- **対象**: `./markdown/*.md`ファイル
- **表示形式**: ファイル名一覧（クリック可能）
- **ソート**: 更新日時順、名前順
- **フィルター**: ファイル名検索機能

#### ファイル選択・プレビュー

- **選択方法**: ファイル名クリック
- **プレビュー**: リアルタイム HTML 変換
- **文字数表示**: 280 文字制限との比較
- **エラー表示**: ファイル読み込みエラー処理

#### ファイル操作

- **新規作成**:
  - ファイル名入力フォーム
  - テンプレート選択機能
  - 初期内容の設定
- **編集機能**:
  - インライン編集（`st.text_area`）
  - 保存・キャンセル機能
  - 変更検知・確認ダイアログ
- **削除機能**:
  - 削除確認ダイアログ
  - 安全な削除処理

### 右ペイン機能

#### 投稿設定エリア

- **選択ファイル表示**: 現在選択中のファイル名
- **投稿タイトル**: 入力フィールド（必須）
- **内容確認**: 左ペインと連動した内容表示
- **文字数チェック**: 280 文字制限の可視化

#### スケジュール設定

- **投稿タイプ選択**:
  - 即時投稿
  - 予約投稿
- **日時指定**:
  - `st.date_input()`: 日付選択
  - `st.time_input()`: 時刻選択
  - 最小日時: 現在時刻以降
- **繰り返し設定**:
  - なし/日次/週次/月次
  - 終了日設定

#### レート制限表示

- **日次制限**: 17/24 時間（ダミーデータ）
- **月次制限**: 500/月（ダミーデータ）
- **次回リセット**: 計算による表示
- **制限状況**: プログレスバー表示

#### モック投稿機能

- **投稿ボタン**: 「投稿予約」ボタン
- **バリデーション**: 内容・制限チェック
- **モック処理**: 成功/失敗のシミュレーション
- **結果表示**: 成功メッセージ・エラーメッセージ

---

## 画面設計

### メインレイアウト

```
┌─────────────────────────────────────────────────────────┐
│ X Scheduler Pro - 投稿作成                               │
├─────────────────┬───────────────────────────────────────┤
│ 📁 Markdownファイル │ 📝 投稿作成                            │
│                 │                                     │
│ ┌─────────────┐ │ ┌─────────────────────────────────┐ │
│ │sample1.md   │ │ │投稿タイトル: _______________     │ │
│ │sample2.md   │ │ │                               │ │
│ │template.md  │ │ │選択ファイル: sample1.md        │ │
│ └─────────────┘ │ │                               │ │
│                 │ │🕐 スケジュール設定               │ │
│ ┌─────────────┐ │ │ ○ 即時投稿 ○ 予約投稿          │ │
│ │プレビュー    │ │ │ 日付: [2024-01-01]           │ │
│ │# Sample     │ │ │ 時刻: [12:00]                │ │
│ │今日の投稿... │ │ │                               │ │
│ │             │ │ │📊 制限状況                    │ │
│ │文字数: 45/280│ │ │ 日次: ████░░░░░░ 8/17        │ │
│ └─────────────┘ │ │ 月次: ███░░░░░░░ 150/500     │ │
│                 │ │                               │ │
│ [新規] [編集] [削除] │ │ [📤 投稿予約]                 │ │
└─────────────────┴───────────────────────────────────────┘
```

### ファイル操作ダイアログ

```
┌─────────────────────────────────┐
│ 新規Markdownファイル作成          │
├─────────────────────────────────┤
│ ファイル名: _______________      │
│                               │
│ テンプレート選択:               │
│ ○ 空白ファイル                 │
│ ○ 日次投稿テンプレート          │
│ ○ イベント告知テンプレート       │
│                               │
│ [作成] [キャンセル]             │
└─────────────────────────────────┘
```

---

## データ管理

### セッション状態管理

```python
# ファイル管理
st.session_state.selected_file = None
st.session_state.file_content = ""
st.session_state.file_list = []

# 投稿設定
st.session_state.post_title = ""
st.session_state.post_type = "immediate"
st.session_state.scheduled_date = None
st.session_state.scheduled_time = None

# UI状態
st.session_state.editing_mode = False
st.session_state.show_preview = True
```

### ローカルファイル操作

```python
# ファイル読み込み
def load_markdown_file(filepath):
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return f.read()
    except Exception as e:
        return f"Error: {str(e)}"

# ファイル保存
def save_markdown_file(filepath, content):
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        return True
    except Exception as e:
        st.error(f"保存エラー: {str(e)}")
        return False
```

### モックデータ管理

```python
# レート制限（ダミーデータ）
mock_rate_limit = {
    "daily_used": 8,
    "daily_limit": 17,
    "monthly_used": 150,
    "monthly_limit": 500,
    "reset_time": "2024-01-02 00:00:00"
}

# 投稿履歴（ダミーデータ）
mock_post_history = [
    {"id": "1", "title": "今日の振り返り", "status": "success", "posted_at": "2024-01-01 12:00"},
    {"id": "2", "title": "イベント告知", "status": "scheduled", "scheduled_at": "2024-01-02 15:00"}
]
```

---

## エラーハンドリング

### ファイル操作エラー

- **読み込みエラー**: ファイルが見つからない、権限不足
- **保存エラー**: ディスク容量不足、権限不足
- **削除エラー**: ファイルロック、権限不足

### バリデーションエラー

- **文字数超過**: 280 文字制限
- **必須項目**: タイトル未入力
- **日時設定**: 過去日時の指定

### UI 状態エラー

- **選択ファイルなし**: 操作時のファイル未選択
- **編集競合**: 同時編集の検知
- **状態不整合**: セッション状態の復元エラー

---

## テスト項目

### ファイル管理テスト

- [ ] ファイル一覧の正常表示
- [ ] ファイル選択・プレビュー機能
- [ ] 新規ファイル作成機能
- [ ] ファイル編集・保存機能
- [ ] ファイル削除機能
- [ ] エラーハンドリング

### UI 連携テスト

- [ ] 左右ペイン間のデータ連動
- [ ] リアルタイムプレビュー
- [ ] 文字数カウンター
- [ ] レスポンシブ表示

### フォーム機能テスト

- [ ] 投稿タイトル入力
- [ ] スケジュール設定
- [ ] バリデーション機能
- [ ] モック投稿処理

### パフォーマンステスト

- [ ] 大容量Markdownファイルの処理
- [ ] Streamlitキャッシュの効果確認
- [ ] セッション状態の最適化
- [ ] ファイル読み込み速度の測定

### エラーハンドリングテスト

- [ ] ファイル操作エラー
- [ ] バリデーションエラー
- [ ] UI 状態エラー
- [ ] 非同期処理エラー

---

## 成果物

### 実装ファイル

- `app.py`: メインアプリケーション
- `components/file_manager.py`: ファイル管理コンポーネント
- `components/post_form.py`: 投稿フォームコンポーネント
- `components/preview.py`: プレビューコンポーネント
- `utils/file_utils.py`: ファイル操作ユーティリティ
- `utils/markdown_utils.py`: Markdown 処理ユーティリティ

### サンプルデータ

- `markdown/sample1.md`: サンプル Markdown ファイル
- `markdown/template.md`: テンプレートファイル
- `config/mock_data.json`: モックデータ設定

### ドキュメント

- UI 操作マニュアル
- ファイル管理ガイド
- カスタマイズガイド

---

## 次のタスクへの引き継ぎ

### 提供機能

- 完成した UI レイアウト
- ファイル管理機能
- 投稿フォーム機能
- モックデータ管理

### 連携ポイント

- 投稿ボタンの処理を Task 3 で実装
- モックデータを Firestore 連携に変更
- レート制限表示を実データに変更

### セッション状態

- `st.session_state.selected_file`: 選択ファイル
- `st.session_state.post_data`: 投稿データ
- `st.session_state.schedule_data`: スケジュールデータ

この基盤により、Task 3 では実際の X API 投稿機能の実装に集中できます。
